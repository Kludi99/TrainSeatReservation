@model TrainSeatReservation.Commons.Dto.TrainDto

@{
    ViewData["Title"] = "Reserve Seats";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<div class="container">
    @using (Html.BeginForm("PersonalData", "SearchingList", FormMethod.Post))
    {
        <div class="optional-items">
            <div class="row">
                <div class="col-6">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#chooseSeatsModal">Wybierz</button>
                </div>
                <div class="col-6">
                    <p>Wybierz miejsce ze schematu</p>
                </div>
                <div id="seatsDiv" style="display:none" class="col-12">
                 
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <input type="checkbox" id="allowInformation" name="allowInformation"  />
                </div>
                <div class="col-6">
                    <p>Zezwól na informacje SMS</p>
                </div>

            </div>
            <div class="row">
                <div class="col-12">
                    <div class="next-button">
                        @Html.Hidden("carriageId")
                        @Html.Hidden("seats")
                        @Html.Hidden("allow")
                        <button type="submit" id="submitButton">Przejdź dalej</button>
                    </div>
                </div>
            </div>
        </div>
    }
    </div>
<div class="modal fade" id="chooseSeatsModal" tabindex="-1" role="dialog" aria-labelledby="chooseSeatsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chooseSeatsModalLabel">Wybierz miejsce</h5> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
            </div>
            <div class="modal-body" style="min-height: 600px">
                <div id="carouselExampleControls" class="carousel slide" data-ride="carousel" data-interval="false">
                    <div class="carousel-inner">
                        @{
                            var first = true;
                        }
                        @foreach (var item in Model.TrainCarriages)
                        {
                            <div class="carousel-item @(first ? Html.Raw("active") : Html.Raw(""))">
                                <div class="row">
                                    <div class="col-sm-12"><p>Wagon: @item.Carriage.Number </p></div>
                                    <div class="col-sm-12">Wybrane miejsca:  <input id="seats" value=""></div>
                                    <div class="col-sm-12">

                                        @if (item.Carriage.TypeId == 6) //bezprzedziałowy
                                        {
                                            <div class="window direction col-12">
                                                @foreach (var seat in item.Carriage.Seats)
                                                {
                                                    @if (seat.SeatTypeId == 9 && seat.IsTravelDirection)
                                                    {
                                                        <button class='seat @(seat.IsFree ? "available" : "reserved disabled") direction window' value="@seat.Number">
                                                            @seat.Number
                                                        </button>
                                                    }

                                                }
                                            </div>
                                            <div class="corridor direction col-12">
                                                @foreach (var seat in item.Carriage.Seats)
                                                {
                                                    @if (seat.SeatTypeId == 10 && seat.IsTravelDirection)
                                                    {
                                                        <button class='seat @(seat.IsFree ? "available" : "reserved disabled") direction corridor' value="@seat.Number">
                                                            @seat.Number
                                                        </button>
                                                    }
                                                }
                                            </div>
                                            <div class="corridor nonDirection col-12">
                                                @foreach (var seat in item.Carriage.Seats)
                                                {
                                                    @if (seat.SeatTypeId == 10 && !(seat.IsTravelDirection))
                                                    {
                                                        <button class='seat @(seat.IsFree ? "available" : "reserved disabled") nonDirection corridor' value="@seat.Number">
                                                            @seat.Number
                                                        </button>
                                                    }
                                                }
                                            </div>


                                            <div class="window nonDirection col-12">
                                                @foreach (var seat in item.Carriage.Seats)
                                                {
                                                    @if (seat.SeatTypeId == 9 && !(seat.IsTravelDirection))
                                                    {
                                                        <button class='seat @(seat.IsFree ? "available" : "reserved disabled") nonDirection window' value="@seat.Number">
                                                            @seat.Number
                                                        </button>
                                                    }
                                                }
                                            </div>


                                        }
                                        else //przedziałowy
                                        {
                                            var counter = 0;
                                            <div class="compartment">
                                                <div class="compartment-inside">
                                                    @foreach (var seat in item.Carriage.Seats)
                                                    {
                                                        if (seat.Number < 20)
                                                        {
                                                            if (counter % 3 == 0)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-window' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else if (counter % 3 == 2)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-corridor' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-middle' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }

                                                            counter++;
                                                        }
                                                        else continue;
                                                    }
                                                </div>
                                            </div>

                                            <div class="compartment">
                                                <div class="compartment-inside">
                                                    @foreach (var seat in item.Carriage.Seats)
                                                    {
                                                        if (seat.Number < 30 && seat.Number >= 20)
                                                        {
                                                            if (counter % 3 == 0)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-window' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else if (counter % 3 == 2)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-corridor' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-middle' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }

                                                            counter++;
                                                        }
                                                        else continue;
                                                    }
                                                </div>
                                            </div>
                                            <div class="compartment">
                                                <div class="compartment-inside">
                                                    @foreach (var seat in item.Carriage.Seats)
                                                    {
                                                        if (seat.Number < 40 && seat.Number >= 30)
                                                        {
                                                            if (counter % 3 == 0)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-window' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else if (counter % 3 == 2)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-corridor' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-middle' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }

                                                            counter++;
                                                        }
                                                        else continue;
                                                    }
                                                </div>
                                            </div>
                                            <div class="compartment">
                                                <div class="compartment-inside">
                                                    @foreach (var seat in item.Carriage.Seats)
                                                    {
                                                        if (seat.Number < 50 && seat.Number >= 40)
                                                        {
                                                            if (counter % 3 == 0)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-window' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else if (counter % 3 == 2)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-corridor' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-middle' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }

                                                            counter++;
                                                        }
                                                        else continue;
                                                    }
                                                </div>
                                            </div>

                                            <div class="compartment">
                                                <div class="compartment-inside">
                                                    @foreach (var seat in item.Carriage.Seats)
                                                    {
                                                        if (seat.Number < 60 && seat.Number >= 50)
                                                        {
                                                            if (counter % 3 == 0)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-window' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else if (counter % 3 == 2)
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-corridor' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <button class='seat @(seat.IsFree ? "available" : "reserved disabled") compartment-middle' value="@seat.Number">
                                                                    @seat.Number
                                                                </button>
                                                            }

                                                            counter++;
                                                        }
                                                        else continue;
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                            </div>
                            first = false;

                        }

                    </div>
                    <a class="carousel-control-prev" href="#carouselExampleControls" role="button"
                       data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselExampleControls" role="button"
                       data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
                @*<ul>
                <li><a href="#step-1">Step 1<br /><small>Account Info</small></a></li>
                <li><a href="#step-2">Step 2<br /><small>Personal Info</small></a></li>
                <li><a href="#step-3">Step 3<br /><small>Payment Info</small></a></li>
                <li><a href="#step-4">Step 4<br /><small>Confirm details</small></a></li>
            </ul>
            <div class="mt-4">
                <div id="step-1">
                    <div class="row">
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="Name" required> </div>
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="Email" required> </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="Password" required> </div>
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="Repeat password" required> </div>
                    </div>
                </div>
                <div id="step-2">
                    <div class="row">
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="Address" required> </div>
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="City" required> </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="State" required> </div>
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="Country" required> </div>
                    </div>
                </div>
                <div id="step-3" class="">
                    <div class="row">
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="Card Number" required> </div>
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="Card Holder Name" required> </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="CVV" required> </div>
                        <div class="col-md-6"> <input type="text" class="form-control" placeholder="Mobile Number" required> </div>
                    </div>
                </div>
                <div id="step-4" class="">
                    <div class="row">
                        <div class="col-md-12"> <span>Thanks For submitting your details with BBBootstrap.com. we will send you a confirmation email. We will review your details and revert back.</span> </div>
                    </div>
                </div>
            </div>*@

                @* </div> *@
            </div>
            <div class="modal-footer">
                <button type="submit" class="modal-button" id="submitModalButton">Zatwierdź</button>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        var c = @ViewBag.SeatsCount;
        let counter = 0;
            $('.nxt').click(function () {

            $(this).parent(".carriage").animate({ left: '-150%' }, 500);
            $(this).parent(".carriage").next(".carriage").animate({ left: '50%' }, 500);
        });
        $('.prv').click(function () {

            $(this).parent(".carriage").animate({ left: '150%' }, 500);
            $(this).parent(".carriage").prev(".carriage").animate({ left: '50%' }, 500);
        });

        function removeSeat(seatListElm, seatValue) {
            var arr = seatListElm.value.split(',');

            var p = arr.indexOf(seatValue);
            if (p != -1) {
                arr.splice(p, 1);
                seatListElm.value = arr.join(',');
            }
            counter--;
        }

        function checkListCount(seatListElm) {
            var arr = seatListElm.value.split(',');
            if (arr.length < c) {
                return true;
            }
            else return false;
        }
        //add seat to list
        function addSeat(seatListElm, seatValue) {
            var arr = seatListElm.value.split(',');
           // if (arr.length < c) {
                if (arr.join() == '') { arr = []; }
                //console.log(seatValue);
                var p = arr.indexOf(seatValue);
                if (p == -1) {
                    arr.push(seatValue); //append
                    arr = arr.sort(); //sort list
                    seatListElm.value = arr.join(',');
                }
                counter++;
          //  }
        //    else { alert("za duzo");}

        }
        $('.carousel-control-prev').click(function () {
            var activecarriage = document.querySelector(".active  input:first-of-type");
            activecarriage.value = "";
            $(".seat").each(function () {
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                }
            });
            counter = 0;
        });
        $('.carousel-control-next').click(function () {
            var activecarriage = document.querySelector(".active  input:first-of-type");
            activecarriage.value = "";
            $(".seat").each(function () {
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                }
            });
            counter = 0;
        });
        function removeItems() {
            var activecarriage = document.querySelector(".active  input:first-of-type");
            activecarriage.value = "";
        }
        //called everytime a seat is clicked
        function seatClick(seat) {
            seat = (this instanceof HTMLButtonElement) ? this : seat;
            var firstSelected;
            var selectedSeats = [];
            var thisInputHasAlreadyBeenSeen = false;
            var confirmedSeats = [];

            var activecarriage = document.querySelector(".active  input:first-of-type");//document.getElementsByTagName('div').getElementsByClassName('active');//.getElementsByTagName('input');//[0];
          
                if (seat.classList.contains('reserved') == false) {
                    //if (checkListCount(activecarriage) && seat.classList.contains('selected') == false) {
                    if (seat.classList.contains('selected') == false) {
                        if (counter < c) {
                            addSeat(activecarriage, seat.value);
                            seat.classList.add('selected');
                        } else { alert("Wybrano maksymalną liczbę miejsc!");}

                    } else {
                        removeSeat(activecarriage, seat.value);
                        seat.classList.remove('selected');
                    }
                    //   }
                    // else if (!checkListCount(activecarriage)) { alert("duzo za duzo");}

                } else {
                    alert("This seat is reserved!\nPlease select another seat");
                    removeSeat(activecarriage, seat.value);
                    return;
                }
            
           
        }


        //adding event click to seats
        var elms = document.getElementsByClassName('seat');
        for (var i = 0, l = elms.length; i < l; i++) {
            elms[i].onclick = seatClick;
        }

        $("#submitModalButton").click(function () {

            var div = document.getElementById("seatsDiv");
           // alert("Div");
            var activecarriageSeats = document.querySelector(".active  input:first-of-type").value;
           // alert(activecarriageSeats);
            var paragrahpCarriage = document.querySelector(".active  p:first-of-type").innerHTML;
           // console.log(paragrahpCarriage);
            var activeCarriageNumber = paragrahpCarriage.split(' ')[1];

            if (div.style.display === "none") {
                div.style.display = "block";
            }
            if (counter != c)
                alert("Nie wybrano wszystkich siedzeń. Mogą zostać wybrane losowo");
            // $("#disountsDiv span").append(discountType1);
            //  $("#disountsDiv span").append(discountCount1);


            //$("#disountsDiv").append('<input name"firstDiscountTypeName" id="firstDiscountTypeName" value="' + discountType1 + '" readonly />');
            //$("#disountsDiv").append('<input name"firstDiscountCount" id="firstDiscountCount" value="' + discountCount1 + '" readonly />');
            $("#seatsDiv")
                .html('<p>Wybrane miejsca: Wagon numer</p><input name"carriageInput" id="carriageInput" value = "' + activeCarriageNumber + '" readonly /><p>Numery siedzeń: </p><input name"seatsInput" id="seatsInput" value = "' + activecarriageSeats + '" readonly />');

            $('#carriageId').val(activeCarriageNumber);
            console.log(activeCarriageNumber);
            $('#seats').val(activecarriageSeats);
            console.log($('#seats').val());
            console.log($('#carriageId').val());
            $('#chooseSeatsModal').modal('hide');


        });
        $("#submitButton").click(function () {
            $('#carriageId').val($('#carriageInput').val());
            $('#seats').val($('#seatsInput').val());
            var allow = $("#allowInformation").prop("checked") ;
            alert(allow);
            $('#allow').val(allow);

        });
    });
</script>